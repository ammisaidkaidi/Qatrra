/**
 * @template T
 * @extends {Array<T>}
 */
export class IndexedArray extends Array {
    /**
     * @extends {Array<T>}
     * 
     */
    keyPath;
    _index = new Map();
    _instanceSet = new WeakSet();
    constructor(keyPath) {
        super();
        this.keyPath = keyPath;
        if (!arguments.length)
            throw new Error("");
    }
    validateAndIndex(item) {
        if (!item || typeof item !== 'object' || item[this.keyPath] === undefined) {
            return false;
        }
        if (this._instanceSet.has(item)) {
            return false;
        }
        if (this._index.has(item[this.keyPath])) {
            Object.assign(this._index.get(item[this.keyPath]), item);
            return false;
        }
        const id = item[this.keyPath];
        //Object.defineProperty(item, 'id', { get() { return id; }, set() { }, enumerable: false });
        this._index.set(item[this.keyPath], item);
        this._instanceSet.add(item);
        return true;
    }
    validateAndIndexs(items) {
        return items.filter(item => {
            if (this.validateAndIndex(item) === false)
                return false;
            return true;
        });
    }
    unindex(item) {
        if (item && item[this.keyPath] !== undefined) {
            this._index.delete(item[this.keyPath]);
            this._instanceSet.delete(item);
        }
    }
    push(...items) {
        return super.push(...this.validateAndIndexs(items));
    }
    unshift(...items) {
        return super.unshift(...this.validateAndIndexs(items));
    }
    replaceItemsBy(items) {
        this.splice(0, this.length, ...items);
        return this;
    }
    set(item) {
        if (item instanceof Array)
            return this.push.apply(this, item);
        if (this.validateAndIndex(item))
            return super.push(item);
        return -1;
    }
    pop() {
        const item = super.pop();
        this.unindex(item);
        return item;
    }
    shift() {
        const item = super.shift();
        this.unindex(item);
        return item;
    }
    splice(start, deleteCount = 0, ...items) {
        const itemsToDelete = deleteCount > 0 ? this.slice(start, start + deleteCount) : [];
        itemsToDelete.forEach(item => this.unindex(item));
        items = this.validateAndIndexs(items);
        return super.splice(start, deleteCount, ...items);
    }
    get(id) {
        return this._index.get(id);
    }
    fill(value, start = 0, end = this.length) {
        const fillStart = Math.max(0, start);
        const fillEnd = Math.min(this.length, end);
        const fillRange = fillEnd - fillStart;
        if (fillRange > 1) {
            throw new Error('fill() cannot be used with a range greater than 1 as it inserts the same object instance multiple times, violating uniqueness.');
        }
        if (fillRange === 1) {
            this.unindex(this[fillStart]);
            if (!this.validateAndIndex(value))
                return this;
        }
        return super.fill(value, start, end);
    }
    copyWithin(target, start, end) {
        throw new Error('copyWithin() is not supported as it would break instance uniqueness by duplicating references.');
    }
    deleteById(id) {
        const f = this._index.get(id);
        if (f) {
            this._index.delete(id);
            this._instanceSet.delete(f);
            const i = this.indexOf(f);
            if (i !== -1)
                this.splice(i, 1);
        }
        return true;
    }
    delete(row_id) {
        this.deleteById(row_id instanceof Object ? row_id[this.keyPath] : row_id);
    }
    deletes(row_id) {
        if (row_id instanceof Array)
            row_id.forEach(function (r) { this.delete(r); }, this);
        else
            this.delete(row_id);
    }
}
export function createIndexedArray(keyPath, ...items) {
    const targetArray = new IndexedArray(keyPath);
    return targetArray;
    return new Proxy(targetArray, {
        set(target, property, value, receiver) {
            if (typeof property !== 'string' || isNaN(Number(property))) {
                return Reflect.set(target, property, value, receiver);
            }
            const index = Number(property);
            if (index < target.length) {
                const oldItem = target[index];
                target.unindex(oldItem);
                try {
                    target.validateAndIndex(value);
                    const result = Reflect.set(target, property, value, receiver);
                    return result;
                }
                catch (e) {
                    target.validateAndIndex(oldItem);
                    throw e;
                }
            }
            target.splice(property, 1, value);
            throw new Error("Direct index assignment is only allowed for replacing existing elements, and assignment outside array bounds is forbidden. Use .push() or .splice().");
        }
    });
}
function assign(target, ...sources) {
    sources.forEach(source => {
        if (source != null) {
            for (let key in source) {
                if (Object.prototype.hasOwnProperty.call(source, key)) {
                    try {
                        target[key] = source[key];
                    }
                    catch (error) {
                    }
                }
            }
        }
    });
    return target;
}
Object.assign = assign;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5wdXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbnB1dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxNQUFNLE9BQU8sWUFBa0QsU0FBUSxLQUFLO0lBTW5EO0lBSnJCLE1BQU0sR0FBRyxJQUFJLEdBQUcsRUFBVyxDQUFDO0lBRTVCLFlBQVksR0FBRyxJQUFJLE9BQU8sRUFBSyxDQUFDO0lBRWhDLFlBQXFCLE9BQVU7UUFDM0IsS0FBSyxFQUFFLENBQUM7UUFEUyxZQUFPLEdBQVAsT0FBTyxDQUFHO1FBRTNCLElBQUcsQ0FBQyxTQUFTLENBQUMsTUFBTTtZQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7SUFFOUMsQ0FBQztJQUdELGdCQUFnQixDQUFDLElBQU87UUFDcEIsSUFBSSxDQUFDLElBQUksSUFBSSxPQUFPLElBQUksS0FBSyxRQUFRLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxTQUFTLEVBQUUsQ0FBQztZQUN4RSxPQUFPLEtBQUssQ0FBQztRQUNqQixDQUFDO1FBR0QsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQzlCLE9BQU8sS0FBSyxDQUFDO1FBRWpCLENBQUM7UUFHRCxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQ3RDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQzlELE9BQU8sS0FBSyxDQUFDO1FBQ2pCLENBQUM7UUFDRCxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzlCLE1BQU0sQ0FBQyxjQUFjLENB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QUE2QixFQUFFLEdBQUcsT0FBYztJQUM1RCxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1FBQ3JCLElBQUksTUFBTSxJQUFJLElBQUksRUFBRSxDQUFDO1lBQ2pCLEtBQUssSUFBSSxHQUFHLElBQUksTUFBTSxFQUFFLENBQUM7Z0JBQ3JCLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDO29CQUNwRCxJQUFJLENBQUM7d0JBRUQsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDOUIsQ0FBQztvQkFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO29CQUVqQixDQUFDO2dCQUNMLENBQUM7WUFDTCxDQUFDO1FBQ0wsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0gsT0FBTyxNQUFNLENBQUM7QUFDbEIsQ0FBQztBQUNELE1BQU0sQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGNsYXNzIEluZGV4ZWRBcnJheTxUIGV4dGVuZHMgb2JqZWN0LCBQIGV4dGVuZHMga2V5b2YgVD4gZXh0ZW5kcyBBcnJheSB7XG4gICAgLy8gUHJpdmF0ZSBmaWVsZCBmb3IgSUQtdG8taXRlbSBtYXBwaW5nXG4gICAgX2luZGV4ID0gbmV3IE1hcDxUW1BdLCBUPigpO1xuICAgIC8vIFByaXZhdGUgZmllbGQgZm9yIGluc3RhbmNlLXRvLUlEIG1hcHBpbmcgKHRvIGNoZWNrIGZvciBkdXBsaWNhdGUgaW5zdGFuY2VzKVxuICAgIF9pbnN0YW5jZVNldCA9IG5ldyBXZWFrU2V0PFQ+KCk7XG5cbiAgICBjb25zdHJ1Y3RvcihyZWFkb25seSBrZXlQYXRoOiBQKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIGlmKCFhcmd1bWVudHMubGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoXCJcIik7XG4gICAgICAgIFxuICAgIH1cblxuICAgIC8vIEhlbHBlciBtZXRob2QgZm9yIHZhbGlkYXRpb24gYW5kIHVuaXF1ZW5lc3MgY2hlY2tzXG4gICAgdmFsaWRhdGVBbmRJbmRleChpdGVtOiBUKSB7XG4gICAgICAgIGlmICghaXRlbSB8fCB0eXBlb2YgaXRlbSAhPT0gJ29iamVjdCcgfHwgaXRlbVt0aGlzLmtleVBhdGhdID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENoZWNrIDE6IEluc3RhbmNlIFVuaXF1ZW5lc3NcbiAgICAgICAgaWYgKHRoaXMuX2luc3RhbmNlU2V0LmhhcyhpdGVtKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgLy90aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBhZGQgdGhlIHNhbWUgb2JqZWN0IGluc3RhbmNlIHR3aWNlLiBJRDogJyR7aXRlbVt0aGlzLmtleVBhdGhdfScuYCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDaGVjayAyOiBJRCBVbmlxdWVuZXNzXG4gICAgICAgIGlmICh0aGlzLl9pbmRleC5oYXMoaXRlbVt0aGlzLmtleVBhdGhdKSkge1xuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLl9pbmRleC5nZXQoaXRlbVt0aGlzLmtleVBhdGhdKSBhcyBULCBpdGVtKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBpZCA9IGl0ZW1bdGhpcy5rZXlQYXRoXTtcbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGl0ZW0sICdpZCcsIHsgZ2V0KCkgeyByZXR1cm4gaWQ7IH0sIHNldCgpIHsgfSwgZW51bWVyYWJsZTogZmFsc2UgfSk7XG4gICAgICAgIHRoaXMuX2luZGV4LnNldChpdGVtW3RoaXMua2V5UGF0aF0sIGl0ZW0pO1xuICAgICAgICB0aGlzLl9pbnN0YW5jZVNldC5hZGQoaXRlbSk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICB2YWxpZGF0ZUFuZEluZGV4cyhpdGVtczogVFtdKSB7XG4gICAgICAgIHJldHVybiBpdGVtcy5maWx0ZXIoaXRlbSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy52YWxpZGF0ZUFuZEluZGV4KGl0ZW0pID09PSBmYWxzZSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAvLyBIZWxwZXIgbWV0aG9kIHRvIHJlbW92ZSB0cmFja2luZ1xuICAgIHVuaW5kZXgoaXRlbTogVCkge1xuICAgICAgICBpZiAoaXRlbSAmJiBpdGVtW3RoaXMua2V5UGF0aF0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5faW5kZXguZGVsZXRlKGl0ZW1bdGhpcy5rZXlQYXRoXSk7XG4gICAgICAgICAgICB0aGlzLl9pbnN0YW5jZVNldC5kZWxldGUoaXRlbSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyAtLS0gTXV0YXRvciBNZXRob2RzIC0tLVxuXG4gICAgcHVzaCguLi5pdGVtczogVFtdKSB7XG4gICAgICAgIHJldHVybiBzdXBlci5wdXNoKC4uLnRoaXMudmFsaWRhdGVBbmRJbmRleHMoaXRlbXMpKTtcbiAgICB9XG5cbiAgICB1bnNoaWZ0KC4uLml0ZW1zOiBUW10pIHtcbiAgICAgICAgcmV0dXJuIHN1cGVyLnVuc2hpZnQoLi4udGhpcy52YWxpZGF0ZUFuZEluZGV4cyhpdGVtcykpO1xuXG4gICAgfVxuICAgIHJlcGxhY2VJdGVtc0J5KGl0ZW1zOiBUW10pIHtcbiAgICAgICAgdGhpcy5zcGxpY2UoMCwgdGhpcy5sZW5ndGgsIC4uLml0ZW1zKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuICAgIHNldChpdGVtOiBUW10gfCBUKSB7XG4gICAgICAgIGlmIChpdGVtIGluc3RhbmNlb2YgQXJyYXkpIHJldHVybiB0aGlzLnB1c2guYXBwbHkodGhpcywgaXRlbSk7XG4gICAgICAgIGlmICh0aGlzLnZhbGlkYXRlQW5kSW5kZXgoaXRlbSkpXG4gICAgICAgICAgICByZXR1cm4gc3VwZXIucHVzaChpdGVtKTtcbiAgICAgICAgcmV0dXJuIC0xO1xuICAgIH1cbiAgICBwb3AoKSB7XG4gICAgICAgIGNvbnN0IGl0ZW0gPSBzdXBlci5wb3AoKTtcbiAgICAgICAgdGhpcy51bmluZGV4KGl0ZW0pO1xuICAgICAgICByZXR1cm4gaXRlbTtcbiAgICB9XG5cbiAgICBzaGlmdCgpIHtcbiAgICAgICAgY29uc3QgaXRlbSA9IHN1cGVyLnNoaWZ0KCk7XG4gICAgICAgIHRoaXMudW5pbmRleChpdGVtKTtcbiAgICAgICAgcmV0dXJuIGl0ZW07XG4gICAgfVxuXG4gICAgc3BsaWNlKHN0YXJ0OiBudW1iZXIsIGRlbGV0ZUNvdW50ID0gMCwgLi4uaXRlbXM6IFRbXSkge1xuICAgICAgICAvLyAxLiBNYXJrIGl0ZW1zIGZvciByZW1vdmFsIGZyb20gdHJhY2tpbmdcbiAgICAgICAgY29uc3QgaXRlbXNUb0RlbGV0ZSA9IGRlbGV0ZUNvdW50ID4gMCA/IHRoaXMuc2xpY2Uoc3RhcnQsIHN0YXJ0ICsgZGVsZXRlQ291bnQpIDogW107XG4gICAgICAgIGl0ZW1zVG9EZWxldGUuZm9yRWFjaChpdGVtID0+IHRoaXMudW5pbmRleChpdGVtKSk7XG5cbiAgICAgICAgLy8gMi4gVmFsaWRhdGUgYW5kIG1hcmsgbmV3IGl0ZW1zIGZvciB0cmFja2luZ1xuICAgICAgICBpdGVtcyA9IHRoaXMudmFsaWRhdGVBbmRJbmRleHMoaXRlbXMpO1xuXG4gICAgICAgIC8vIDMuIFBlcmZvcm0gdGhlIGFycmF5IG9wZXJhdGlvblxuICAgICAgICByZXR1cm4gc3VwZXIuc3BsaWNlKHN0YXJ0LCBkZWxldGVDb3VudCwgLi4uaXRlbXMpO1xuICAgIH1cblxuICAgIC8vIC0tLSBVdGlsaXR5IE1ldGhvZHMgLS0tXG5cbiAgICBnZXQoaWQ6IGFueSkge1xuICAgICAgICByZXR1cm4gdGhpcy5faW5kZXguZ2V0KGlkKTtcbiAgICB9XG5cbiAgICAvLyBOT1RFIG9uIGBmaWxsYDogZmlsbCgpIGlzIGluaGVyZW50bHkgaW5jb21wYXRpYmxlIHdpdGggaW5zdGFuY2UgdW5pcXVlbmVzcyBcbiAgICAvLyBpZiB0aGUgZmlsbCByYW5nZSBpcyA+IDEsIGFzIGl0IGluc2VydHMgdGhlIHNhbWUgcmVmZXJlbmNlIG9iamVjdC4gXG4gICAgLy8gV2UgdGhyb3cgYW4gZXJyb3IgdG8gcHJldmVudCBjb3JydXB0aW9uLlxuICAgIGZpbGwodmFsdWU6IFQsIHN0YXJ0ID0gMCwgZW5kID0gdGhpcy5sZW5ndGgpIHtcbiAgICAgICAgY29uc3QgZmlsbFN0YXJ0ID0gTWF0aC5tYXgoMCwgc3RhcnQpO1xuICAgICAgICBjb25zdCBmaWxsRW5kID0gTWF0aC5taW4odGhpcy5sZW5ndGgsIGVuZCk7XG4gICAgICAgIGNvbnN0IGZpbGxSYW5nZSA9IGZpbGxFbmQgLSBmaWxsU3RhcnQ7XG5cbiAgICAgICAgaWYgKGZpbGxSYW5nZSA+IDEpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignZmlsbCgpIGNhbm5vdCBiZSB1c2VkIHdpdGggYSByYW5nZSBncmVhdGVyIHRoYW4gMSBhcyBpdCBpbnNlcnRzIHRoZSBzYW1lIG9iamVjdCBpbnN0YW5jZSBtdWx0aXBsZSB0aW1lcywgdmlvbGF0aW5nIHVuaXF1ZW5lc3MuJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGZpbGxSYW5nZSA9PT0gMSkge1xuICAgICAgICAgICAgLy8gUmVtb3ZlIG9sZCBpdGVtXG4gICAgICAgICAgICB0aGlzLnVuaW5kZXgodGhpc1tmaWxsU3RhcnRdKTtcbiAgICAgICAgICAgIC8vIFZhbGlkYXRlL0luZGV4IG5ldyBpdGVtXG4gICAgICAgICAgICBpZiAoIXRoaXMudmFsaWRhdGVBbmRJbmRleCh2YWx1ZSkpIHJldHVybiB0aGlzO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHN1cGVyLmZpbGwodmFsdWUsIHN0YXJ0LCBlbmQpO1xuICAgIH1cbiAgICBjb3B5V2l0aGluKHRhcmdldDogYW55LCBzdGFydDogYW55LCBlbmQ6IGFueSk6IHRoaXMge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NvcHlXaXRoaW4oKSBpcyBub3Qgc3VwcG9ydGVkIGFzIGl0IHdvdWxkIGJyZWFrIGluc3RhbmNlIHVuaXF1ZW5lc3MgYnkgZHVwbGljYXRpbmcgcmVmZXJlbmNlcy4nKTtcbiAgICB9XG4gICAgZGVsZXRlQnlJZChpZDogVFtQXSkge1xuICAgICAgICBjb25zdCBmID0gdGhpcy5faW5kZXguZ2V0KGlkKTtcbiAgICAgICAgaWYgKGYpIHtcbiAgICAgICAgICAgIHRoaXMuX2luZGV4LmRlbGV0ZShpZCk7XG4gICAgICAgICAgICB0aGlzLl9pbnN0YW5jZVNldC5kZWxldGUoZik7XG4gICAgICAgICAgICBjb25zdCBpID0gdGhpcy5pbmRleE9mKGYpO1xuICAgICAgICAgICAgaWYgKGkgIT09IC0xKSB0aGlzLnNwbGljZShpLCAxKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBkZWxldGUocm93X2lkOiBUW1BdIHwgVCkge1xuICAgICAgICB0aGlzLmRlbGV0ZUJ5SWQocm93X2lkIGluc3RhbmNlb2YgT2JqZWN0ID8gcm93X2lkW3RoaXMua2V5UGF0aF0gOiByb3dfaWQpO1xuICAgIH1cbiAgICBkZWxldGVzKHJvd19pZDogQXJyYXk8VFtQXSB8IFQ+KTogdm9pZDtcbiAgICBkZWxldGVzKHJvd19pZDogVFtQXSk6IHZvaWQ7XG4gICAgZGVsZXRlcyhyb3dfaWQ6IFQpOiB2b2lkXG4gICAgZGVsZXRlcyhyb3dfaWQ6IEFycmF5PFRbUF0gfCBUPiB8IChUW1BdIHwgVCkpIHtcbiAgICAgICAgaWYgKHJvd19pZCBpbnN0YW5jZW9mIEFycmF5KVxuICAgICAgICAgICAgcm93X2lkLmZvckVhY2goZnVuY3Rpb24gKHRoaXM6IEluZGV4ZWRBcnJheTxhbnksIGFueT4sIHIpIHsgdGhpcy5kZWxldGUocik7IH0sIHRoaXMpO1xuICAgICAgICBlbHNlIHRoaXMuZGVsZXRlKHJvd19pZCk7XG4gICAgfVxufVxuXG5cbi8vIEZhY3RvcnkgZnVuY3Rpb24gdG8gY3JlYXRlIGFuZCB3cmFwIHRoZSBhcnJheSBpbiBhIFByb3h5XG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlSW5kZXhlZEFycmF5PFQgZXh0ZW5kcyBvYmplY3Q+KGtleVBhdGg6IGtleW9mIFQsIC4uLml0ZW1zOiBUW10pIHtcbiAgICBjb25zdCB0YXJnZXRBcnJheSA9IG5ldyBJbmRleGVkQXJyYXk8VCwga2V5b2YgVD4oa2V5UGF0aCk7XG4gICAgcmV0dXJuIHRhcmdldEFycmF5O1xuICAgIHJldHVybiBuZXcgUHJveHkodGFyZ2V0QXJyYXksIHtcbiAgICAgICAgLy8gMS4gSW50ZXJjZXB0cyBBTEwgcHJvcGVydHkgYXNzaWdubWVudHM6IGFycmF5WzBdID0gaXRlbTtcbiAgICAgICAgc2V0KHRhcmdldCwgcHJvcGVydHksIHZhbHVlLCByZWNlaXZlcikge1xuICAgICAgICAgICAgLy8gQWxsb3cgbm9uLW51bWVyaWMgcHJvcGVydGllcyAoZS5nLiwgJ2xlbmd0aCcsIGN1c3RvbSBtZXRob2RzKVxuICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm9wZXJ0eSAhPT0gJ3N0cmluZycgfHwgaXNOYU4oTnVtYmVyKHByb3BlcnR5KSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUmVmbGVjdC5zZXQodGFyZ2V0LCBwcm9wZXJ0eSwgdmFsdWUsIHJlY2VpdmVyKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gLS0tIEN1c3RvbSBMb2dpYyBmb3IgSW5kZXggQXNzaWdubWVudCAtLS1cblxuICAgICAgICAgICAgY29uc3QgaW5kZXggPSBOdW1iZXIocHJvcGVydHkpO1xuXG4gICAgICAgICAgICAvLyBDaGVjayBpZiBhc3NpZ25tZW50IGlzIHdpdGhpbiBhcnJheSBib3VuZHMgKHJlcGxhY2VtZW50KVxuICAgICAgICAgICAgaWYgKGluZGV4IDwgdGFyZ2V0Lmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIC8vIDEuIEdldCB0aGUgb2xkIGl0ZW0gdGhhdCBpcyBhYm91dCB0byBiZSByZXBsYWNlZFxuICAgICAgICAgICAgICAgIGNvbnN0IG9sZEl0ZW0gPSB0YXJnZXRbaW5kZXhdO1xuXG4gICAgICAgICAgICAgICAgLy8gMi4gVGVtcG9yYXJpbHkgcmVtb3ZlIHRoZSBvbGQgaXRlbSdzIHRyYWNraW5nXG4gICAgICAgICAgICAgICAgdGFyZ2V0LnVuaW5kZXgob2xkSXRlbSk7XG4gICAgICAgICAgICAgICAgLy8gTk9URTogV2UgbmVlZCBhIHByaXZhdGUgbWV0aG9kIGFjY2Vzc2libGUgaGVyZSwgb3IgbWFrZSBpdCBwdWJsaWMvcHJvdGVjdGVkXG5cbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAvLyAzLiBWYWxpZGF0ZSBhbmQgdHJhY2sgdGhlIG5ldyBpdGVtXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldC52YWxpZGF0ZUFuZEluZGV4KHZhbHVlKTsgLy8gTk9URTogU2FtZSBhY2Nlc3NpYmlsaXR5IGlzc3VlXG5cbiAgICAgICAgICAgICAgICAgICAgLy8gNC4gUGVyZm9ybSB0aGUgbmF0aXZlIGFycmF5IGFzc2lnbm1lbnRcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gUmVmbGVjdC5zZXQodGFyZ2V0LCBwcm9wZXJ0eSwgdmFsdWUsIHJlY2VpdmVyKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIDUuIElmIHZhbGlkYXRpb24gZmFpbHMsIHJldmVydCB0aGUgY2hhbmdlIGJ5IHJlLWluZGV4aW5nIHRoZSBvbGQgaXRlbVxuICAgICAgICAgICAgICAgICAgICB0YXJnZXQudmFsaWRhdGVBbmRJbmRleChvbGRJdGVtKTtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTsgLy8gUmUtdGhyb3cgdGhlIG9yaWdpbmFsIGVycm9yXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBJZiBhc3NpZ25tZW50IGlzIG91dHNpZGUgYm91bmRzIChlLmcuLCBhcnJheVs1XSA9IGl0ZW0gb24gYSBsZW5ndGggMyBhcnJheSksXG4gICAgICAgICAgICAvLyBpdCBzaG91bGQgYmUgdHJlYXRlZCBsaWtlIGEgcHVzaC9tdXRhdGlvbiwgd2hpY2ggaXMgY29tcGxleCB0byBoYW5kbGUgY29ycmVjdGx5XG4gICAgICAgICAgICAvLyB2aWEgcHJveHksIHNvIHdlJ2xsIHRyZWF0IG91dC1vZi1ib3VuZHMgaW5kZXggYXNzaWdubWVudCBhcyBhbiBlcnJvclxuICAgICAgICAgICAgLy8gdG8gZm9yY2UgdGhlIHVzZXIgdG8gdXNlIC5wdXNoKCkgb3IgLnNwbGljZSgpLlxuICAgICAgICAgICAgdGFyZ2V0LnNwbGljZShwcm9wZXJ0eSBhcyBhbnkgYXMgbnVtYmVyLCAxLCB2YWx1ZSk7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJEaXJlY3QgaW5kZXggYXNzaWdubWVudCBpcyBvbmx5IGFsbG93ZWQgZm9yIHJlcGxhY2luZyBleGlzdGluZyBlbGVtZW50cywgYW5kIGFzc2lnbm1lbnQgb3V0c2lkZSBhcnJheSBib3VuZHMgaXMgZm9yYmlkZGVuLiBVc2UgLnB1c2goKSBvciAuc3BsaWNlKCkuXCIpO1xuICAgICAgICB9XG4gICAgfSk7XG59XG5cblxuZnVuY3Rpb24gYXNzaWduKHRhcmdldDogeyBbeDogc3RyaW5nXTogYW55OyB9LCAuLi5zb3VyY2VzOiBhbnlbXSkge1xuICAgIHNvdXJjZXMuZm9yRWFjaChzb3VyY2UgPT4ge1xuICAgICAgICBpZiAoc291cmNlICE9IG51bGwpIHtcbiAgICAgICAgICAgIGZvciAobGV0IGtleSBpbiBzb3VyY2UpIHtcbiAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHNvdXJjZSwga2V5KSkge1xuICAgICAgICAgICAgICAgICAgICB0cnkge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRba2V5XSA9IHNvdXJjZVtrZXldO1xuICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gdGFyZ2V0O1xufVxuT2JqZWN0LmFzc2lnbiA9IGFzc2lnbjsiXX0=